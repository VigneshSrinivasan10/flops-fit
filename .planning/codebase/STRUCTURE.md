# Codebase Structure

**Analysis Date:** 2026-02-15

## Directory Layout

```
flops-fit/
├── src/
│   └── flops_fit/           # Main Python package
│       ├── conf/            # Hydra YAML configuration files
│       │   ├── presets/     # Named presets (cpu_fast, cpu_full)
│       │   ├── planner.yaml
│       │   ├── trainer.yaml
│       │   ├── analyzer.yaml
│       │   └── visualizer.yaml
│       ├── __init__.py      # Package exports and version
│       ├── model.py         # GPT model with u-mup parameterization
│       ├── planner.py       # Sweep configuration generator
│       ├── trainer.py       # Training runner (mock/local/api)
│       ├── analyzer.py      # Power law fitting and analysis
│       └── visualizer.py    # Matplotlib plot generation
├── tests/
│   ├── __init__.py
│   ├── test_planner.py
│   └── test_analyzer.py
├── outputs/                 # Runtime artifacts (gitignored)
│   ├── sweep.json           # Generated by planner
│   ├── results.json         # Generated by trainer
│   ├── analysis/
│   │   └── scaling_laws.json
│   └── plots/
│       ├── isoflops_curves.png
│       ├── scaling_laws.png
│       └── tokens_per_param.png
├── .planning/               # GSD planning documents
│   └── codebase/
├── .cache/                  # HuggingFace dataset cache (gitignored)
├── flops-fit.sh             # Shell entry point / subcommand dispatcher
├── pyproject.toml           # Project metadata, dependencies, console scripts
├── README.md
└── RECOMMENDATIONS.md
```

## Directory Purposes

**`src/flops_fit/`:**
- Purpose: The entire Python package lives here; `pyproject.toml` sets `package-dir = {"" = "src"}`
- Contains: Four pipeline stage modules, the model module, package init, and the `conf/` subtree
- Key files: `src/flops_fit/__init__.py` (exports `GPT`, `GPTConfig`, `SweepPlanner`, `TrainingRunner`, `ScalingLawAnalyzer`, `ScalingVisualizer`)

**`src/flops_fit/conf/`:**
- Purpose: Hydra configuration tree; each YAML file maps to one pipeline stage
- Contains: Per-stage YAML defaults for compute budgets, paths, hardware, model architecture, u-mup settings
- Key files: `src/flops_fit/conf/trainer.yaml` (most complex; covers dataset, hardware, training hyperparams, u-mup)

**`src/flops_fit/conf/presets/`:**
- Purpose: Named configuration overrides for specific hardware profiles
- Contains: `cpu_fast.yaml` (quick experiments on CPU), `cpu_full.yaml` (full sweep on CPU)
- Usage: `ff-plan --config-name=presets/cpu_fast`

**`tests/`:**
- Purpose: Pytest test suite; mirrors package structure at the module level
- Contains: `test_planner.py` (tests for `SweepPlanner` and `ExperimentConfig`), `test_analyzer.py` (tests for `ScalingLawAnalyzer` and fitting functions)
- Key files: `tests/__init__.py` (empty, marks as package)

**`outputs/`:**
- Purpose: Runtime artifact directory; created automatically by pipeline stages
- Contains: JSON data files passed between stages and PNG plot outputs
- Generated: Yes — do not commit (listed in `.gitignore`)

## Key File Locations

**Entry Points:**
- `flops-fit.sh`: Root shell dispatcher; routes `plan`/`train`/`analyze`/`visualize` subcommands
- `src/flops_fit/planner.py:main()`: `ff-plan` console script entry point
- `src/flops_fit/trainer.py:main()`: `ff-train` console script entry point
- `src/flops_fit/analyzer.py:main()`: `ff-analyze` console script entry point
- `src/flops_fit/visualizer.py:main()`: `ff-visualize` console script entry point

**Configuration:**
- `pyproject.toml`: Project metadata, dependency pinning, console script declarations, ruff and pytest config
- `src/flops_fit/conf/planner.yaml`: Compute budget range, model size bounds, output path
- `src/flops_fit/conf/trainer.yaml`: Training mode, dataset, hardware, hyperparameters, u-mup settings
- `src/flops_fit/conf/analyzer.yaml`: Result paths, fitting method, validation settings
- `src/flops_fit/conf/visualizer.yaml`: Plot paths, style settings

**Core Logic:**
- `src/flops_fit/model.py`: `GPT`, `GPTConfig`, `CausalSelfAttention`, `FeedForward`, `TransformerBlock`, `RMSNorm`, `RotaryEmbedding`; u-mup init and optimizer configuration
- `src/flops_fit/planner.py`: `SweepPlanner`, `ExperimentConfig`; IsoFLOP grid generation
- `src/flops_fit/trainer.py`: `TrainingRunner`, `TrainingResult`; mock/local/api training dispatch
- `src/flops_fit/analyzer.py`: `ScalingLawAnalyzer`, `ScalingAnalysis`, `PowerLawFit`; scipy power law fitting
- `src/flops_fit/visualizer.py`: `ScalingVisualizer`; matplotlib IsoFLOP and scaling law plots

**Testing:**
- `tests/test_planner.py`: Unit tests for `SweepPlanner` (FLOPs formula, token calculation, sweep generation, config serialization)
- `tests/test_analyzer.py`: Unit tests for `ScalingLawAnalyzer` (power law fitting, optimal point detection)

## Naming Conventions

**Files:**
- Python modules: `snake_case.py` matching the class they primarily export (e.g., `planner.py` → `SweepPlanner`)
- Config files: `snake_case.yaml` matching the module they configure (e.g., `trainer.yaml`)
- Test files: `test_{module_name}.py` (e.g., `test_planner.py`)

**Directories:**
- Python package: `flops_fit` (underscore, matches project name `flops-fit`)
- Config presets: `presets/` (plural noun)

**Classes:**
- Pipeline stage classes: `{Noun}{Role}` pattern — `SweepPlanner`, `TrainingRunner`, `ScalingLawAnalyzer`, `ScalingVisualizer`
- Dataclasses for results: `{Stage}Result` or `{Concept}Config` — `TrainingResult`, `ExperimentConfig`, `GPTConfig`, `PowerLawFit`, `ScalingAnalysis`
- PyTorch modules: Standard names — `GPT`, `CausalSelfAttention`, `FeedForward`, `TransformerBlock`, `RMSNorm`, `RotaryEmbedding`

**Functions:**
- Public methods: `snake_case` verbs — `generate_sweep()`, `run_experiment()`, `fit_power_law()`, `plot_isoflops()`
- Private methods: `_snake_case` — `_mock_train()`, `_setup_style()`, `_build_cache()`
- `to_dict()`: Used consistently across all dataclasses for JSON serialization

## Where to Add New Code

**New pipeline stage:**
- Implementation: `src/flops_fit/{stage_name}.py` with a class + `@hydra.main` decorated `main()`
- Config: `src/flops_fit/conf/{stage_name}.yaml`
- Console script: Add `ff-{stage_name} = "flops_fit.{stage_name}:main"` to `[project.scripts]` in `pyproject.toml`
- Tests: `tests/test_{stage_name}.py`
- Dispatcher: Add case to `flops-fit.sh`

**New training mode (beyond mock/local/api):**
- Implementation: Add `_{mode}_train()` method to `TrainingRunner` in `src/flops_fit/trainer.py`
- Register in `TrainingRunner.__init__()` under `if mode == "{mode}"`
- Document in `src/flops_fit/conf/trainer.yaml` comments

**New model architecture:**
- Implementation: Add to `src/flops_fit/model.py`, export from `src/flops_fit/__init__.py`
- Follow `GPTConfig` + `nn.Module` pattern with `configure_optimizers()` for u-mup support

**New visualization:**
- Implementation: Add `plot_{name}()` method to `ScalingVisualizer` in `src/flops_fit/visualizer.py`
- Register in `ScalingVisualizer.plot_all()` with try/except guard

**New config preset:**
- Implementation: Add `src/flops_fit/conf/presets/{preset_name}.yaml`
- Usage: `ff-plan --config-name=presets/{preset_name}`

**Utilities:**
- Shared helpers: Add to the most relevant module (e.g., FLOPs math utilities belong in `src/flops_fit/model.py` near `estimate_model_flops`)
- No dedicated `utils.py` exists; keep helpers close to their consumers

## Special Directories

**`outputs/`:**
- Purpose: Runtime data exchange between pipeline stages (sweep configs, training results, analysis, plots)
- Generated: Yes (created automatically by pipeline stages via `mkdir(parents=True, exist_ok=True)`)
- Committed: No (in `.gitignore`); a `.gitkeep` is present to track the empty directory

**`.cache/`:**
- Purpose: HuggingFace datasets cache for tokenized TinyStories dataset
- Generated: Yes (populated when `ff-train` downloads/tokenizes dataset in local mode)
- Committed: No

**`src/flops_fit/conf/`:**
- Purpose: Hydra config tree; must be co-located with the package because `@hydra.main` uses `config_path="conf"` relative to the module file
- Generated: No
- Committed: Yes

**`.planning/`:**
- Purpose: GSD planning and codebase analysis documents
- Generated: Yes (by GSD commands)
- Committed: Yes

---

*Structure analysis: 2026-02-15*
