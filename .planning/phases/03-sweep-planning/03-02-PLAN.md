---
phase: 03-sweep-planning
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/flops_fit/__init__.py
  - src/flops_fit/api.py
  - tests/test_api.py
autonomous: true

must_haves:
  truths:
    - "find_optimal() returns a SweepPlan when compute_budgets are provided (inspectable data structure, not an exception)"
    - "SweepPlan is importable from flops_fit top-level package"
    - "find_optimal() still works without compute_budgets (backward compat)"
    - "Validation order is preserved: model -> dataset -> loss_fn -> sweep planning"
  artifacts:
    - path: "src/flops_fit/api.py"
      provides: "find_optimal() with sweep planning integration"
      contains: "plan_sweep"
    - path: "src/flops_fit/__init__.py"
      provides: "SweepPlan export"
      contains: "SweepPlan"
    - path: "tests/test_api.py"
      provides: "Integration tests for sweep planning via find_optimal()"
      contains: "test_.*compute_budgets"
  key_links:
    - from: "src/flops_fit/api.py"
      to: "src/flops_fit/sweep.py"
      via: "plan_sweep() import and call"
      pattern: "from flops_fit.sweep import plan_sweep"
    - from: "src/flops_fit/__init__.py"
      to: "src/flops_fit/sweep.py"
      via: "SweepPlan re-export"
      pattern: "from flops_fit.sweep import SweepPlan"
---

<objective>
Wire plan_sweep() into find_optimal() and export SweepPlan from the package. Add integration tests verifying sweep planning works through the public API.

Purpose: Users call find_optimal() with compute_budgets and get sweep planning as part of the pipeline. SweepPlan is importable for direct use.
Output: Updated api.py, __init__.py, and test_api.py.
</objective>

<execution_context>
@/home/viggie/.claude/get-shit-done/workflows/execute-plan.md
@/home/viggie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sweep-planning/03-01-SUMMARY.md
@src/flops_fit/api.py
@src/flops_fit/__init__.py
@tests/test_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sweep planning into find_optimal() and export SweepPlan</name>
  <files>src/flops_fit/api.py, src/flops_fit/__init__.py</files>
  <action>
Update src/flops_fit/api.py:
1. Add import: `from flops_fit.sweep import plan_sweep`
2. After loss_fn validation, add sweep planning block that **returns** the SweepPlan:
   ```python
   # Phase 3: Generate and return sweep plan
   if compute_budgets is not None:
       plan = plan_sweep(
           model_cls=model_cls,
           size_param=model_size_param,
           model_kwargs=model_kwargs,
           compute_budgets=compute_budgets,
       )
       return plan
   ```
   This is the key behavior: when compute_budgets are provided, find_optimal() returns the SweepPlan as an inspectable data structure. The phase goal is pre-commitment visibility -- the user gets a plan they can inspect before any training happens.
3. Keep the existing NotImplementedError for the no-budgets path (unchanged):
   - Without budgets: "find_optimal() model validation passed. Full pipeline not yet implemented."
4. Update the docstring Returns section to document the two-branch behavior:
   - With compute_budgets: returns a SweepPlan (inspectable experiment grid)
   - Without compute_budgets: raises NotImplementedError (training pipeline not yet implemented)

Update src/flops_fit/__init__.py:
1. Add import: `from flops_fit.sweep import SweepPlan, Experiment, plan_sweep`
2. Add to __all__: `"SweepPlan"`, `"Experiment"`, `"plan_sweep"` (under a "# Sweep Planning" comment block)
  </action>
  <verify>
Run `python -c "from flops_fit import SweepPlan, Experiment, plan_sweep; print('exports ok')"`. Run `python -m pytest tests/test_api.py -v` to verify existing tests still pass (the NotImplementedError message match in existing tests needs updating since we changed the message -- check and update test match strings if needed).
  </verify>
  <done>
find_optimal() calls plan_sweep() and returns the SweepPlan when compute_budgets are provided. Without compute_budgets, it still raises NotImplementedError. SweepPlan, Experiment, and plan_sweep are importable from flops_fit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for sweep planning via find_optimal()</name>
  <files>tests/test_api.py</files>
  <action>
Add a new test class `TestFindOptimalSweepPlanning` to tests/test_api.py:

1. **test_returns_sweep_plan**: Call `find_optimal(MockModel, "width", model_kwargs={"num_layers": 4}, compute_budgets=[1e15, 1e16])`. Assert it **returns** (does NOT raise) a SweepPlan instance. Assert `result.num_experiments > 0`. Assert `result.compute_budgets == [1e15, 1e16]`. This is the critical test: the SweepPlan is inspectable as a data structure, not hidden behind an exception.

2. **test_no_compute_budgets_raises_not_implemented**: Call `find_optimal(MockModel, "width")` without compute_budgets. Assert raises NotImplementedError with "model validation passed" (original message, confirming no sweep planning ran -- backward compat).

3. **test_compute_budgets_none_raises_not_implemented**: Call `find_optimal(MockModel, "width", compute_budgets=None)`. Same assertion as above.

4. **test_model_validated_before_sweep**: Call `find_optimal(BadModel, "width", compute_budgets=[1e15])`. Assert raises TypeError with "num_params" (model validation fails before sweep planning starts).

5. **test_dataset_validated_before_sweep**: Call `find_optimal(MockModel, "width", dataset="not_a_dataset", compute_budgets=[1e15])`. Assert raises TypeError with "Expected a torch.utils.data.Dataset" (dataset validated before sweep).

6. **test_loss_validated_before_sweep**: Call `find_optimal(MockModel, "width", dataset=TinyDataset(), loss_fn=42, compute_budgets=[1e15])`. Assert raises TypeError with "loss_fn must be callable" (loss validated before sweep).

**Existing test updates required:** The existing tests in `TestFindOptimalDatasetValidation` and `TestFindOptimalLossValidation` that call find_optimal() with valid inputs and match "model validation passed" do NOT pass compute_budgets, so they still hit the NotImplementedError path and need NO changes. Verify this by confirming those tests don't pass compute_budgets -- they don't, so they remain correct.
  </action>
  <verify>
Run `cd /home/viggie/Projects/flops-fit && python -m pytest tests/test_api.py -v`. All tests pass (existing + new). Run `python -m pytest tests/ -v` to verify no regressions.
  </verify>
  <done>
6 new integration tests verify: compute_budgets triggers sweep planning, backward compat without budgets, validation order (model -> dataset -> loss -> sweep).
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/test_api.py -v` -- all API tests pass (existing + new)
- `python -m pytest tests/ -v` -- no regressions
- `python -c "from flops_fit import SweepPlan, plan_sweep; print('top-level imports ok')"` -- importable
- `python -c "from flops_fit import find_optimal"` -- still works
</verification>

<success_criteria>
find_optimal() returns an inspectable SweepPlan when compute_budgets are provided (no exception). Without compute_budgets, it raises NotImplementedError (backward compat). SweepPlan is a top-level export, and validation order is enforced.
</success_criteria>

<output>
After completion, create `.planning/phases/03-sweep-planning/03-02-SUMMARY.md`
</output>
