---
phase: 01-library-skeleton-and-model-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/flops_fit/__init__.py
  - src/flops_fit/api.py
  - src/flops_fit/model_factory.py
  - tests/test_model_factory.py
  - tests/test_api.py
autonomous: true

must_haves:
  truths:
    - "User can `import flops_fit` and `flops_fit.find_optimal` is a callable"
    - "User can pass a model class + size parameter name + kwargs, and the library creates model instances at different sizes"
    - "Library validates that model class has `num_params()` and raises TypeError if not"
    - "Package installs via `pip install -e .` with new files"
  artifacts:
    - path: "src/flops_fit/model_factory.py"
      provides: "Model instantiation and contract validation"
      exports: ["create_model", "create_models_at_sizes", "validate_model_contract"]
    - path: "src/flops_fit/api.py"
      provides: "Public find_optimal() entry point"
      exports: ["find_optimal"]
    - path: "src/flops_fit/__init__.py"
      provides: "Package exports including find_optimal"
      contains: "find_optimal"
    - path: "tests/test_model_factory.py"
      provides: "Factory and validation tests"
      min_lines: 40
    - path: "tests/test_api.py"
      provides: "API entry point tests"
      min_lines: 20
  key_links:
    - from: "src/flops_fit/api.py"
      to: "src/flops_fit/model_factory.py"
      via: "import validate_model_contract"
      pattern: "from flops_fit\\.model_factory import"
    - from: "src/flops_fit/__init__.py"
      to: "src/flops_fit/api.py"
      via: "import find_optimal"
      pattern: "from flops_fit\\.api import find_optimal"
---

<objective>
Create the flops_fit library skeleton: model factory for creating models at different sizes, contract validation (num_params check), and the find_optimal() public API stub.

Purpose: Users can import flops_fit, call find_optimal() with a model class, and get immediate validation that their model meets the library contract. This is the foundation every later phase builds on.
Output: model_factory.py, api.py, updated __init__.py, and tests proving the contract works.
</objective>

<execution_context>
@/home/viggie/.claude/get-shit-done/workflows/execute-plan.md
@/home/viggie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-library-skeleton-and-model-interface/01-RESEARCH.md
@src/flops_fit/__init__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model factory, API stub, and package exports</name>
  <files>
    src/flops_fit/model_factory.py
    src/flops_fit/api.py
    src/flops_fit/__init__.py
  </files>
  <action>
Create `src/flops_fit/model_factory.py` with three functions:

1. `create_model(model_cls, size_param, size_value, model_kwargs)` - Creates a single model instance by merging `{size_param: size_value, **model_kwargs}` and calling `model_cls(**merged)`. Returns the instance.

2. `create_models_at_sizes(model_cls, size_param, size_values, model_kwargs)` - Calls `create_model` for each value in `size_values`. Returns list of `(size_value, model_instance)` tuples.

3. `validate_model_contract(model_cls, size_param, model_kwargs)` - Creates a probe instance (use a small default probe value, e.g., 64, or the value from model_kwargs if size_param is present there) and validates:
   - `model_cls` is callable (try instantiation, catch TypeError)
   - `size_param` is accepted as a constructor arg (caught by the same try/except)
   - Instance has `num_params` attribute (use `hasattr`, raise TypeError with helpful message including "Did you mean count_parameters()?" hint)
   - `num_params()` returns a positive int (raise ValueError if not)
   - If `size_param` is in `model_kwargs`, issue a `warnings.warn()` and remove it from kwargs before proceeding (per research recommendation)
   - Returns the probe instance

Error messages must be specific and actionable, following the examples in the RESEARCH.md (include class name, parameter name, and what was expected).

Create `src/flops_fit/api.py` with:

1. `find_optimal(model_cls, model_size_param, model_kwargs=None, dataset=None, loss_fn=None, compute_budgets=None, **kwargs)` - Validates model_kwargs defaults to {}, calls `validate_model_contract(model_cls, model_size_param, model_kwargs)`, then raises `NotImplementedError("find_optimal() model validation passed. Full pipeline not yet implemented.")`.

Update `src/flops_fit/__init__.py`:
- Add `from flops_fit.api import find_optimal` import
- Add `"find_optimal"` to `__all__`
- Keep ALL existing imports and exports unchanged (GPT, GPTConfig, SweepPlanner, etc.)
  </action>
  <verify>
Run `python -c "import flops_fit; print(callable(flops_fit.find_optimal))"` -- must print `True`.
Run `python -c "from flops_fit.model_factory import create_model, create_models_at_sizes, validate_model_contract; print('OK')"` -- must print `OK`.
  </verify>
  <done>
- `flops_fit.find_optimal` is importable and callable
- `model_factory.py` exports create_model, create_models_at_sizes, validate_model_contract
- Existing imports (`from flops_fit import GPT`) still work
- api.py calls validate_model_contract then raises NotImplementedError
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for model factory and API</name>
  <files>
    tests/test_model_factory.py
    tests/test_api.py
  </files>
  <action>
Create `tests/test_model_factory.py` with a simple test model class (pure Python, no torch dependency needed for these tests):

```python
class MockModel:
    def __init__(self, width=64, num_layers=4):
        self.width = width
        self.num_layers = num_layers
    def num_params(self):
        return self.width * self.num_layers * 100  # fake but deterministic
```

Test cases for model_factory:

1. `test_create_model_basic` - create_model with MockModel, size_param="width", size_value=128, model_kwargs={"num_layers": 4}. Assert instance.width == 128 and instance.num_layers == 4.

2. `test_create_models_at_sizes` - create_models_at_sizes with size_values=[64, 128, 256]. Assert returns 3 tuples, each with correct size_value and model instance. Assert num_params() differs across sizes.

3. `test_validate_contract_passes` - validate_model_contract with MockModel succeeds, returns probe instance.

4. `test_validate_missing_num_params` - Class without num_params(). Assert raises TypeError with "num_params" in the message.

5. `test_validate_bad_num_params_return` - Class where num_params() returns a string or negative number. Assert raises ValueError.

6. `test_validate_wrong_size_param` - Use size_param="nonexistent". Assert raises TypeError.

7. `test_validate_size_param_in_kwargs_warns` - Pass size_param="width" with model_kwargs={"width": 32, "num_layers": 4}. Assert issues a warning (use pytest.warns(UserWarning)). Assert validation still succeeds.

Create `tests/test_api.py`:

1. `test_find_optimal_importable` - `from flops_fit import find_optimal` works, callable(find_optimal) is True.

2. `test_find_optimal_validates_then_raises_not_implemented` - Call find_optimal with MockModel. Assert raises NotImplementedError (meaning validation passed but pipeline not yet implemented).

3. `test_find_optimal_rejects_bad_model` - Call find_optimal with a class missing num_params(). Assert raises TypeError (validation catches it before NotImplementedError).

4. `test_find_optimal_default_kwargs` - Call with model_kwargs=None (the default). Assert it still works (raises NotImplementedError, not KeyError or AttributeError).
  </action>
  <verify>
Run `python -m pytest tests/test_model_factory.py tests/test_api.py -v` -- all tests pass.
  </verify>
  <done>
- All test cases pass
- Tests cover: happy path model creation, multi-size creation, contract validation (pass and fail cases), API import and behavior
- No torch dependency required for tests to run
  </done>
</task>

</tasks>

<verification>
1. `pip install -e .` completes successfully
2. `python -c "import flops_fit; print(flops_fit.find_optimal)"` shows the function
3. `python -m pytest tests/test_model_factory.py tests/test_api.py -v` all green
4. `python -c "from flops_fit import GPT"` still works (no regression)
</verification>

<success_criteria>
- find_optimal() is importable from flops_fit and callable
- Model factory creates instances at different sizes by varying size_param
- Contract validation raises clear TypeError when num_params() is missing
- All tests pass
- Existing package imports unbroken
</success_criteria>

<output>
After completion, create `.planning/phases/01-library-skeleton-and-model-interface/01-01-SUMMARY.md`
</output>
